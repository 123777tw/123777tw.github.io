<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><!--声明此文件的编码格式是UTF-8，用于提高与其他环境的兼容性。 Declare that the encoding format of this file is UTF-8, which is used to improve the compatibility with other environments.-->
<title>文件分割 File Slicer</title>
<!--这是一个在内存操作文件的工具，请注意内存占用。 This is a tool for operating files in memory. Please pay attention to memory usage.-->
<script>
function getPreferences() {//获取偏好（）
	var searchString = window.location.search.replace("?", "&");//存储地址参数字符串。 Store the search string.
	if(!searchString) {return;}//如果没有参数字符串立刻返回。 Returned immediately if no search string.
	var checkPreferenceIndex = searchString.lastIndexOf("&check=");//查找并存储最后一个勾选偏好的位置。 Find and store the index of the last check preference.
	if(checkPreferenceIndex != -1) {//如果指定了勾选偏好。 If a check preference are specified.
		var checkPreferencePreprocessingString = searchString.substring(checkPreferenceIndex);//处理并存储勾选偏好预处理字符串。 Process and store the check preference preprocessing string.
		var checkPreferenceStringEndIndex = checkPreferencePreprocessingString.substring(1).indexOf("&") + 1;//查找并存储勾选偏好结束位置。 Find and store the check preference end index.
		var checkPreference = parseInt(checkPreferencePreprocessingString.substring(7, checkPreferenceStringEndIndex ? checkPreferenceStringEndIndex : undefined));//将传入的勾选偏好处理成整数形式并储存。 Process the incoming check preference into integer form and store it.
		//开始：按照二进制位从低到高设置对应勾选节点。 Start: Set the corresponding checkbox node status from low to high according to the binary bit.
		document.getElementById("CheckBox0").checked = checkPreference & 1;
		document.getElementById("CheckBox1").checked = checkPreference >> 1 & 1;
		//结束。 End.
	}
	var sizePerFilePreferenceIndex = searchString.lastIndexOf("&sizePerFile=");//查找并存储最后一个每文件字节数偏好的位置。 Find and store the index of the last size per file preference.
	if(sizePerFilePreferenceIndex != -1) {//如果指定了每文件字节数偏好。 If a size per file preference are specified.
		var sizePerFilePreferencePreprocessingString = searchString.substring(sizePerFilePreferenceIndex);//处理并存储每文件字节数偏好预处理字符串。 Process and store the size per file preference preprocessing string.
		var sizePerFilePreferenceStringEndIndex = sizePerFilePreferencePreprocessingString.substring(1).indexOf("&") + 1;//查找并存储每文件字节数偏好结束位置。 Find and store the size per file preference end index.
		document.getElementById("SizePerFile").value = sizePerFilePreferencePreprocessingString.substring(13, sizePerFilePreferenceStringEndIndex ? sizePerFilePreferenceStringEndIndex : undefined);//将传入的每文件字节数偏好输出到指定输入框。 Output the incoming size per file preference to specified input box.
	}
	var parameterPreferenceIndex = searchString.lastIndexOf("&parameter=");//查找并存储最后一个参数列表偏好的位置。 Find and store the index of the last parameter list preference.
	if(parameterPreferenceIndex != -1) {//如果指定了参数列表偏好。 If a parameter list preference are specified.
		var parameterPreferencePreprocessingString = searchString.substring(parameterPreferenceIndex);//处理并存储参数列表偏好预处理字符串。 Process and store the parameter list preference preprocessing string.
		var parameterPreferenceStringEndIndex = parameterPreferencePreprocessingString.indexOf("&");//查找并存储参数列表偏好结束位置。 Find and store the parameter list preference end index.
		document.getElementById("ParameterList").value = decodeURIComponent(parameterPreferencePreprocessingString.substring(11,parameterPreferenceStringEndIndex ? parameterPreferenceStringEndIndex : undefined));//将传入的参数列表偏好解码并输出到指定文本区域。 Decode the incoming the parameter list preference and output it to specified textarea.
	}
}
</script>
</head>
<body onload="getPreferences();"><!--getPreference函数的实现在头部标签内。 The implementation of the function sliceAndDownloadFiles is in head tag.-->
<label><input type="text" id="SizePerFile" value="1048576" /><!--节点id在sliceAndDownloadFiles函数（实现在本文件内）中会被引用1次。1048576=1M The node id will be referenced once in the function sliceAndDownloadFiles (implemented in this file).-->字节每文件 Bytes per file</label>
<input type="file" style="display:block" onchange="sliceAndDownloadFiles('s',this.files[0])" /><!--sliceAndDownloadFiles函数的实现在下面。The implementation of the function sliceAndDownloadFiles is below.-->
<script>
function sliceAndDownloadFiles(fileName, content) {//拆分并且下载文件（文件名，内容）
	var s = parseInt(document.getElementById("SizePerFile").value);//根据之前定义的id获取到用户希望的分割单位（字节）。这个数字之后会被多次引用。According to the previously defined ID, the desired part unit (byte) is obtained. This number will be referenced many times.
	var blob = new Blob([content]);//将文件的主体转换为Blob对象，且会被多次引用。Converts the content of the file to a blob object, which will be referenced many times.
	var n = Math.ceil(blob.size/s);//确定文件会被分割成几个部分，且会被循环引用。Make sure how many parts the file will be divided into. The number will be referenced circularly.
	for(i = 0; i < n; i ++) {//每次循环将会确定出一个分割部分。Each cycle will determine a part.
		var aTag = document.createElement('a');//预期通过模拟点击<a>节点触发下载动作。It is expected to trigger the download action by simulating clicking the <a> node.
		var sliced = blob.slice(s*i,s*(i+1),'application/octet-stream');//取出分割部分，不考虑文件类型。Take out the split part without regarding the file type.
		aTag.download = fileName + '_' + i;//分割部分的文件名：原始文件名+下划线+下标 The file name of split part: original file name + underline + subscript
		aTag.href = URL.createObjectURL(sliced);//将<a>节点的链接绑定到已经取出的分割部分。Bind the link of the <a> node to the splitted part that has been taken out.
		aTag.click();//模拟点击触发下载动作。Simulate clicking to trigger download action.
		URL.revokeObjectURL(sliced);//释放已经无用的URL对象。Release the used URL object.
	}
}
</script>
<hr /><!--下面是附加的合并文件功能，用于还原被拆分的文件。The following is an additional merge file function for restoring split files.-->
将它们合并回去 Merge them back
<label style="display:block"><input id="CheckBox0" type="checkbox" checked /><!--所有勾选节点id在本文件内将会被多次引用。 All checkbox node IDs will be referenced many times in this file.-->生成高级文件拆分参数列表<div style="display:inline-block;margin-left:20px">Generate advanced file splitting parameter list</div></label>
<input type="file" style="display:block" multiple onchange="mergeAndDownloadFile('merged', this.files);if(document.getElementById('CheckBox0').checked){generateParameterList(this.files,document.getElementById('ParameterList'),document.getElementById('CheckBox1').checked);}" /><!--mergeAndDownloadFile和generateParameterList函数的实现在下面。 The implementation of the function mergeAndDownloadFile and generateParameterList are below.-->
<script>
function mergeAndDownloadFile(fileName, contents) {//合并并且下载文件（文件名，多个内容）
	var blob = new Blob(contents, {type: 'application/octet-stream'});//将多个文件的主体合并转换为一个Blob对象，不考虑文件类型。merged the principals of multiple files into a blob object without regarding the file type.
	var aTag = document.createElement('a');//预期通过模拟点击<a>节点触发下载动作。It is expected to trigger the download action by simulating clicking the <a> node.
	aTag.download = fileName;//设置下载文件的文件名。Set the file name of the download file.
	aTag.href = URL.createObjectURL(blob);//将<a>节点的链接绑定到已经合并的文件。Bind the link of <a> node to the merged file.
	aTag.click();//模拟点击触发下载动作。Simulate clicking to trigger download action.
	URL.revokeObjectURL(blob);//释放已经无用的URL对象。Release the used URL object.
}
function generateParameterList(contents, output, checked1) {//生成参数列表（多个内容，输出，勾选1）
	if(!contents.length) {return;}//如果未选择任何文件立刻返回。If no file is selected, return immediately.
	var parameterList = "";//用于存储预处理字符串。 Used to store preprocessed strings.
	var offset = 0;//用于存储每部分的偏移字节数。 Used to store the number of offset bytes per part.
	for(i = 0; i < contents.length; i ++) {//每次循环处理一个部分的分割参数。 Each cycle processes one part of the parameters.
		parameterList += "," + offset;//追加逗号和起始字节。 Appending comma and start.
		offset += contents[i].size;//根据文件大小计算结束字节。 Calculate end according to the file size.
		parameterList += "~" + offset;//追加颚化符和结束字节。 Append tilde and end.
		if(!checked1) {//判断勾选1状态。 Judge the status of checked1.
			parameterList += "." + contents[i].type;//追加点号和文档类型。 Append dot and contentType.
		}
	}
	output.value = parameterList.substring(1, parameterList.length);//去除最开始多余的逗号并输出到文本区域。 Remove the first redundant comma and output to the textarea.
}
</script>
<hr /><!--下面的高级文件拆分功能是根据Blob.slice函数的功能特点设计的。The following advanced file splitting function is designed based on Blob.slice Function of the functional characteristics.-->
高级文件拆分参数列表 Advanced file splitting parameter list
<label style="display:block"><input id="CheckBox1" type="checkbox" checked onclick="changeTips(this.checked, document.getElementById('ParameterList'))"/><!--所有勾选节点id在本文件内将会被多次引用。changeTips函数的实现在下面。 All checkbox node IDs will be referenced many times in this file. The implementation of the function changeTips is below.-->使用“application/octet-stream”作为文档类型的默认值<div style="display:inline-block;margin-left:20px">Use "application/octet-stream" as the default for contentType</div></label>
<textarea id="ParameterList" style="display:block;width:90%" rows=5 placeholder="star~end,star~end...&#10;起始字节~结束字节,起始字节~结束字节……"></textarea><!--节点id会在本文件内将会被多次引用。 The node ID will be referenced many times in this file.-->
<script>
function changeTips(isChecked, textareaNode) {//修改提示(是否勾选，文本区域节点)
	if(isChecked) {//勾选：使用默认值。Checked: use the default value.
		textareaNode.setAttribute("placeholder", "star~end,star~end...\n起始字节~结束字节,起始字节~结束字节……");//设置使用默认值的配套提示。Set the prompt matching to use the default value.
	} else {//未勾选：不使用默认值。Uncheck: do not use the default value.
		textareaNode.setAttribute("placeholder", "star~end.contentType,star~end.contentType...\n起始字节~结束字节.文档类型,起始字节~结束字节.文档类型……\n参数可根据需要留空。Parameters can be left blank as needed.");//设置不使用默认值的配套提示。Set the prompt matching not to use the default value.
	}
}
</script>
<input type="file" style="display:block" onchange="advancedSliceAndDownloadFiles('s',this.files[0],document.getElementById('ParameterList').value,document.getElementById('CheckBox1').checked)" /><!--advancedSliceAndDownloadFiles函数的实现在下面。The implementation of the function advancedSliceAndDownloadFiles is below.-->
<script>
function advancedSliceAndDownloadFiles(fileName, content, parameterList, checked1) {//高级拆分并且下载文件（文件名，内容，参数列表，勾选1）
	var blob = new Blob([content]);//将文件的主体转换为Blob对象，且会被循环引用。Converts the content of the file to a blob object, which will be referenced circularly.
	var parameters = parameterList.split(",");//将参数字符串拆为数组以遍历。Split the parameter string into an array for traversal.
	var n = parameters.length;//确定文件会被分割成几个部分，且会被循环引用。Make sure how many parts the file will be divided into. The number will be referenced circularly.
	var contentType = checked1?"application/octet-stream":undefined;//根据勾选1状态确定slice函数的第三个参数默认值。 Determine the third parameter default value of slice function according to the status of checked1.
	for(i = 0; i < n; i ++) {//每次循环将会确定出一个分割部分。Each cycle will determine a part.
		var indexOfTilde = parameters[i].indexOf("~");//获取颚化符首次出现的位置。 Get the position where the tilde first appears.
		if(indexOfTilde == -1) {//检查参数字符串是否无效。 Check whether the parameter string is invalid.
			if (confirm("下标为" + i + "的部分参数中没有“~”号，不能确定具体参数，终止执行？\nThere is no \"~\" sign in parameter string with subscript " + i + ", so the specific parameters cannot be determined. Terminate?")) return;//发现无效字符串并弹出终止提示。 Find the invalid string and prompt the termination tips.
			continue;//用户不打算终止，跳过本次循环。The user does not intend to terminate, skipping this loop.
		}
		var start = parameters[i].substring(0,indexOfTilde);//分离start参数。 Separate the start parameter.
		var indexOfDot = parameters[i].indexOf(".");//获取点号首次出现的位置。 Get the position where the dot first appears.
		var end = "";//用于存储end参数。 Used to store the end parameter.
		if(indexOfDot == -1) {//判断是否未指定contentType参数。 Determine whether the contentType parameter is not specified.
			end = parameters[i].substring(indexOfTilde + 1);//分离end参数。 Separate the end parameter.
		} else {//指定了contentType参数。 The contentType parameter is specified.
			end = parameters[i].substring(indexOfTilde + 1,indexOfDot);//分离end参数。 Separate the end parameter.
			contentType = parameters[i].substring(indexOfDot + 1);//替换默认contentType参数。 Replace the default contentType parameter.
		}
		var sliced = blob.slice((start?parseInt(start):undefined),(end?parseInt(end):undefined),(contentType?contentType:undefined));//根据各参数取出分割部分。其中参数为空字符串或各种错误数据将被纠正为undefined。 The segmentation part is taken out according to the parameters. Where the parameters are an empty string or various error data will be corrected to undefined.
		var aTag = document.createElement('a');//预期通过模拟点击<a>节点触发下载动作。It is expected to trigger the download action by simulating clicking the <a> node.
		aTag.download = fileName + '_' + i;//分割部分的文件名：原始文件名+下划线+下标 The file name of split part: original file name + underline + subscript
		aTag.href = URL.createObjectURL(sliced);//将<a>节点的链接绑定到已经取出的分割部分。Bind the link of the <a> node to the splitted part that has been taken out.
		aTag.click();//模拟点击触发下载动作。Simulate clicking to trigger download action.
		URL.revokeObjectURL(sliced);//释放已经无用的URL对象。Release the used URL object.
	}
}
</script>
<hr style="border:1px solid" /><!--针对有偏好传入支持的页面额外添加的偏好链接生成器。-->
<div style="border:1px solid;word-break:break-all"><button type="button" onclick="generatePreferenceLink(this.nextElementSibling,this.nextElementSibling.nextElementSibling,this.nextElementSibling.nextElementSibling.nextElementSibling)">★</button><!--generatePreferenceLink函数的实现在下面。The implementation of the function generatePreferenceLink is below.--><span style="color:grey">点击星星生成偏好链接。 Click the star to generate preference link.</span><span></span><span style="color:Green"></span></div>
<script>
function generatePreferenceLink(before, searchString, after) {//生成偏好链接（之前，参数字符串，之后）
	var currentURL = window.location.href;//缓存当前页面完整的URL字符串，用于获取其中的参数之前的字符串和锚点字符串。请注意，仍然有少数浏览器不支持window.loaction.origin。 Cache the complete URL string of the current page, which is used to obtain the string before the search string and the hash string. Note that there are still a few browsers that don't support window.loaction.origin .
	var afterIndex = currentURL.indexOf("#");//获取锚点字符串的起始位置。 Get the starting position of the hash string.
	if (afterIndex > -1) {//如果存在锚点字符串。 If the hash string exists.
		after.innerHTML = currentURL.substring(afterIndex);//取出锚点字符串。 Obtain the hash string.
		currentURL = currentURL.substring(0,afterIndex);//移除锚点字符串。 Remove the hash string.
	}
	var beforeIndex = currentURL.indexOf("?");//获取参数字符串的起始位置。 Get the starting position of the search string.
	if (beforeIndex > -1) {//如果存在锚点字符串。 If the search string exists.
		before.innerHTML = currentURL.substring(0,beforeIndex);//取出参数之前的字符串。 Obtain the string before the search string.
		currentURL = currentURL.substring(beforeIndex);//移除参数之前字符串。 Remove the string before the search string.
	} else {//如果不存在锚点字符串。 If the search string doesn't exist.
		before.innerHTML = currentURL;//所剩内容均为参数之前的字符串。 All that remains is the string before the search string.
		currentURL = "";//清空缓存字符串。 Clear the cache string.
	}
	searchString.innerHTML = "?check=" + (document.getElementById("CheckBox0").checked + (document.getElementById("CheckBox1").checked << 1)).toString() + (document.getElementById("SizePerFile").value == "1048576" ? "" : "&#38sizePerFile=" + document.getElementById("SizePerFile").value) + (document.getElementById("ParameterList").value.length ? ("&#38parameter=" + encodeURIComponent(document.getElementById("ParameterList").value)) : "");//生成并反馈参数字符串。 Generate and feedback the search string.
}
</script>
</body>
</html>
