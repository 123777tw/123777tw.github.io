<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><!--声明此文件的编码格式是UTF-8，用于提高与其他环境的兼容性。 Declare that the encoding format of this file is UTF-8, which is used to improve the compatibility with other environments.-->
<meta name="viewport" content="width=device-width,initial-scale=1.0"><!--声明视口宽度与可视区域宽度一致，用于改善移动设备上的使用体验。 Declare that the viewport width is consistent with the visual area width, which is used to improve the use experience on mobile devices.-->
<title>画图 Painter</title>
<!--这是一个基于SVG标准实现的画图工具。 This is a drawing tool based on SVG Standard.-->
<script>
var c;//用于存储画布节点以复用。 Used to store the canvas node for reuse.
var s;//用于存储图片本体节点以复用。 Used to store the picture ontology node for reuse.
var sh;//用于存储遮罩节点以复用。 Used to store the shield node for reuse.
var m;//用于存储菜单节点以复用。 Used to store the menu node for reuse.
var d = undefined;//用于缓存每个笔划。 Used to cache each stroke.
var ds = {};//用于存储笔画的额外的样式设置。 Used to store additional style settings of the stroke.
function bodyLoaded(){//所有事件响应相关代码均在静态DOM渲染完毕以后执行。 All event response related codes is executed after static DOM rendering.
	c = document.getElementById("Canvas");//找出画布节点。 Find the canvas node.
	s = c.firstElementChild;//找出图片本体节点。 Find out the picture ontology node.
	sh = document.getElementById("Shield");//找出遮罩节点。 Find the shield node.
	m = document.getElementById("Menu");//找出菜单节点。 Find out the menu node.
	function drop(event){//落笔。 Drop the brush.
		d = document.createElementNS("http://www.w3.org/2000/svg","polyline");//准备绘制一条折线。 Prepare to draw a polyline.
		d.setAttribute("points",event.offsetX+","+event.offsetY);//根据鼠标位置设置起点坐标。 Set the starting point coordinate according to the mouse position.
		if(Object.getOwnPropertyNames(ds).length > 0){d.style.cssText = JSON.stringify(ds).slice(1,-1).replace(/"/g,'').replace(/,/g,';').replace(/_/g,'-');}//为笔画附加可能存在的额外样式设置。 Add the additional style settings of the stroke if exist.
		s.appendChild(d);//绘入。 Draw in.
	}
	function firstDrop(event){//首次落笔。 Drop the brush for the first time.
		c.style.width = Math.floor(getComputedStyle(c).width);//固定画布宽度。 Fix the canvas width.
		c.style.height = Math.floor(getComputedStyle(c).height);//固定画布高度。 Fix the canvas height.
		s.setAttribute("width",c.offsetWidth);//固定图片宽度。 Fix the picture width.
		s.setAttribute("height",c.offsetHeight);//固定图片高度。 Fix the picture height.
		c.parentNode.style.backgroundColor = "grey";//将页面主体背景设置为灰色。 Set the page body background to gray.
		drop(event);//执行落笔步骤。 Perform the steps of dropping the brush.
		c.onmousedown = drop;//重新绑定鼠标按下事件。 Rebind the onmousedown event.
	}
	function lift(event){//抬笔。 Lift the brush.
		if(d != undefined){//盘错：确认已经落笔。 Eliminate accidents: Confirm the brush dropped.
			d.setAttribute("points",d.getAttribute("points")+" "+event.offsetX+","+event.offsetY); //根据鼠标位置追加终点坐标。 Add the stop coordinate according to the mouse position.
			var p = d.getAttribute("points").split(' ');//获取当前笔划经过的所有坐标。 Gets all coordinates that the current stroke passes through.
			d = undefined;//当前笔划完成。 The current stroke is complete.
			for(var i = p.length-1; i > 0; i--){//遍历坐标。 Traverse the coordinates.
				if(p[i] != p[i-1]) return;//当发现任何不同的坐标时不做任何额外处理。 No more processing when any different coordinates are found.
			}
			s.removeChild(s.lastElementChild);//撤销当前笔划，因为它没有任何大小。 Undo the current stroke because it does not have any size.
		}
	}
	function wield(event){//挥笔。Wield the brush.
		if(d != undefined){//盘错：确认已经落笔。 Eliminate accidents: Confirm the brush dropped.
			d.setAttribute("points",d.getAttribute("points")+" "+event.offsetX+","+event.offsetY); //根据鼠标位置追加延续坐标。 Add the continuation coordinate according to the mouse position.
		}
	}
	function others(event){//其他操作。 Other operations.
		event.preventDefault();//取消默认菜单显示。 Cancel the default menu display.
		event.stopPropagation();//阻止事件冒泡。 Prevent the event bubbling.
		sh.style.display = m.style.display = "flex";//显示菜单和遮罩。 Show the menu and the shield.
	}
	c.onmousedown = firstDrop;//绑定首次鼠标按下事件。 Bind the first onmousedown event.
	c.onmouseup = lift;//绑定鼠标抬起事件。 Bind the onmouseup event.
	c.onmousemove = wield;//绑定鼠标移动事件。 Bind the onmousemove event.
	c.oncontextmenu = others;//绑定快捷菜单事件。 Bind the oncontextmenu event.
	//【临时】向移动端（单点触控）兼容：开始。 [TEMPORARY]Compatible with mobile terminal (single touch): start.
	function onTouchStart(event){
		c.onmousedown({offsetX:event.touches[0].pageX-8,offsetY:event.touches[0].pageY-8});
	}
	function onTouchMove(event){
		event.preventDefault();
		c.onmousemove({offsetX:event.touches[0].pageX-8,offsetY:event.touches[0].pageY-8});
	}
	function onTouchEnd(event){
		event.preventDefault();
		c.onmouseup({offsetX:event.changedTouches[0].pageX-8,offsetY:event.changedTouches[0].pageY-8});
	}
	c.ontouchstart = onTouchStart;
	c.ontouchmove = onTouchMove;
	c.ontouchend = onTouchEnd;
	//【临时】向移动端（单点触控）兼容：结束。 [TEMPORARY]Compatible with mobile terminal (single touch): end.
	m.onclick = c.onclick = function(event){event.stopPropagation();}//阻止点击事件冒泡到主体。 Prevent onclick events from bubbling to the body.
	sh.onclick = function(event){
		event.stopPropagation();//阻止点击事件冒泡到主体。 Prevent onclick events from bubbling to the body.
		sh.style.display = m.style.display = 'none';//隐藏菜单和遮罩。 Hide the menu and the shield.
	}
}
//以下是菜单功能。 The following are menu functions.
function strength(sign){//力度
	var much = parseInt(sign.value);//将输入内容转为要设定的值。 Convert the input string to the value to be set.
	if(!much){//没有任何内容或者转化失败。 No content or conversion failed.
		delete ds.stroke_width;//删除笔画宽度设定。 Delete the stroke width setting.
		sign.parentNode.parentNode.previousElementSibling.cells[1].firstElementChild.style.strokeWidth = sign.value = "";//删除展示值。 Delete the display value.
	} else{//有效的输入。 Valid input.
		sign.parentNode.parentNode.previousElementSibling.cells[1].firstElementChild.style.strokeWidth = sign.value = ds.stroke_width = much;//设定并展示最终笔画宽度。 Set and display the final stroke width.
	}
	sh.style.display = m.style.display = "none";//隐藏菜单和遮罩。 Hide the menu and the shield.
}
function strength_reduce(sign){//减小力度
	if(ds.stroke_width > 1){//如果可以继续减小。 If it can be reduced.
		sign.parentNode.parentNode.previousElementSibling.cells[1].firstElementChild.style.strokeWidth = sign.value = --ds.stroke_width;//减小并展示最终笔画宽度。 Reduce and display the final stroke width.
		sh.style.display = m.style.display = "none";//隐藏菜单和遮罩。 Hide the menu and the shield.
	} else{//已经是最小值。 It is already the minimum.
		sign.style.borderColor = "red";//改变边框颜色以警示操作无法执行。 Change the border color to warn that the operation cannot be performed.
		setTimeout(function(){sign.style.borderColor = "white";},500);//半秒后恢复原色。 Restore the primary color in half a second.
	}
}
function strength_increase(sign){//增大力度
	if(!ds.stroke_width){//如果未设定值。 If no value was set.
		ds.stroke_width = 1;//代入默认值。 Substitute the default value.
	}
	sign.parentNode.parentNode.previousElementSibling.cells[1].firstElementChild.style.strokeWidth = sign.value = ++ds.stroke_width;//增大并展示最终笔画宽度。 Increase and display the final stroke width.
	sh.style.display = m.style.display = "none";//隐藏菜单和遮罩。 Hide the menu and the shield.
}
function dip(pigment){//调色板普通蘸取动作。 Normal dipping action on the palette.
	pigment.parentNode.parentNode.lastElementChild.firstElementChild.firstElementChild.value = ds.stroke = pigment.style.backgroundColor;//蘸取并展示颜色。 Dip and show the color.
	sh.style.display = m.style.display = "none";//隐藏菜单和遮罩。 Hide the menu and the shield.
}
function blend(formula){//调色板自定义颜色动作。 Custom color action on the palette.
	if(formula.length > 0){//判断输入框是否填入了内容。 Determine whether the input box is filled with content.
		ds.stroke = formula;//依样设定颜色。 Set the color accordingly.
	} else{//输入框没有任何内容。 Nothing in the input box.
		delete ds.stroke;//删除颜色设定。 Delete the color setting.
	}
	sh.style.display = m.style.display = "none";//隐藏菜单和遮罩。 Hide the menu and the shield.
}
function undo(indicator){//撤销
	if(s.children.length > 1) {//判断是否存在笔画。 Determine whether there are strokes.
		s.removeChild(s.lastElementChild);//移除最后一笔。 Remove the last stroke.
		sh.style.display = m.style.display = "none";//隐藏菜单和遮罩。 Hide the menu and the shield.
	} else{//画布上已经没有任何笔画。 There are no more strokes on the canvas.
		indicator.style.borderColor = "red";//改变边框颜色以警示操作无法执行。 Change the border color to warn that the operation cannot be performed.
		setTimeout(function(){indicator.style.borderColor = "white";},500);//半秒后恢复原色。 Restore the primary color in half a second.
	}
}
function download(){//下载
	var blob = new Blob([c.innerHTML], {type: "application/octet-stream"});//将图片本体封装为二进制文件以便下载。 Encapsulate the picture ontology into a binary file for download.
	var aTag = document.createElement('a');//预期通过模拟点击<a>节点触发下载动作。It is expected to trigger the download action by simulating clicking the <a> node.
	aTag.href = URL.createObjectURL(blob);//将<a>节点的链接绑定到被封装的二进制文件。Bind the link of the <a> node to the binary file that has been encapsulated.
	aTag.download = "Painter.svg";//指定下载文件名。Specify the download file name.
	aTag.click();//模拟点击触发下载动作。Simulate clicking to trigger download action.
	URL.revokeObjectURL(aTag.href);//释放已用过的二进制文件链接。 Release the used binary link.
	sh.style.display = m.style.display = "none";//隐藏菜单和遮罩。 Hide the menu and the shield.
}
</script>
</head>
<body style="margin:0px;padding:8px;background-color:blue" onload="bodyLoaded()" onclick="sh.style.display = m.style.display = 'flex'"><!--8像素边距显示背景颜色：蓝色表示画布大小未固定，灰色表示画布大小已经固定。 8 pixel padding display background color: Blue indicates that the canvas size is not fixed, and gray indicates that the canvas size has been fixed.-->
<div id="Canvas" style="width:100%;height:100%;background-color:white;cursor:crosshair"><svg width="100%" height="100%" xmlns="http://www.w3.org/2000/svg"><style>polyline{fill:none;stroke:black}</style></svg></div><!--画布与图片本体。 The canvas with the picture ontology.-->
<div id="Shield" style="display:none;position:absolute;top:0;left:0;width:100%;height:100%;background-color:#4449"></div><!--遮罩。-->
<div id="Menu" style="display:none;position:absolute;top:0;left:0;width:100%;height:100%;justify-content:center;align-items:center;pointer-events:none"><!--菜单布局框架。 The menu layout frame.-->
<table style="color:white;background-color:black;text-align:center;pointer-events:auto"><!--菜单各项。 The menu items.-->
<tr><td><table id="strokeWeight"><!--笔画粗细 被级联样式表（CSS）选择器引用。 Referenced by CSS Selector.-->
<style>
#strokeWeight td{
	width:25px;
	height:25px;
	padding:0
}
</style>
<tr><td onclick="strength_reduce(this.parentNode.nextElementSibling.firstElementChild.firstElementChild)">
<svg height="25px" width="25px" style="stroke:white;stroke-width:3">
<line x1="4" y1="12" x2="21" y2="12" />
</svg>
</td><td><svg height="25px" width="50px"><line x1="25" y1="0" x2="25" y2="25" style="stroke:aqua"/></svg></td><td onclick="strength_increase(this.parentNode.nextElementSibling.firstElementChild.firstElementChild)">
<svg height="25px" width="25px" style="stroke:white;stroke-width:3">
<line x1="5" y1="12" x2="21" y2="12" />
<line x1="13" y1="4" x2="13" y2="20" />
</svg>
</td></tr>
<tr><td colspan="2"><input style="width:100%" placeholder="╮(╯▽╰)╭"></input></td><td onclick="strength(this.previousElementSibling.firstElementChild)">
<svg height="25px" width="25px" style="stroke:white;stroke-width:2">
<rect x="9" y="1" width="7" height="23" />
<line x1="9" y1="5" x2="13" y2="5" />
<line x1="9" y1="10" x2="12" y2="10" />
<line x1="9" y1="15" x2="13" y2="15" />
<line x1="9" y1="20" x2="12" y2="20" />
</svg>
</td></tr><!--自定义颜色及确认按钮。 Customize color and confirm button.-->
</table></td></tr>
<tr><td><table id="palette"><!--调色盘 被级联样式表（CSS）选择器引用。 Referenced by CSS Selector.-->
<style>
#palette td{
	width:25px;
	height:25px;
	padding:0
}
</style>
<tr><td style="background-color:aqua" onclick="dip(this)"></td><td style="background-color:black" onclick="dip(this)"></td><td style="background-color:blue" onclick="dip(this)"></td><td style="background-color:fuchsia" onclick="dip(this)"></td></tr>
<tr><td style="background-color:gray" onclick="dip(this)"></td><td style="background-color:green" onclick="dip(this)"></td><td style="background-color:lime" onclick="dip(this)"></td><td style="background-color:maroon" onclick="dip(this)"></td></tr>
<tr><td style="background-color:navy" onclick="dip(this)"></td><td style="background-color:olive" onclick="dip(this)"></td><td style="background-color:purple" onclick="dip(this)"></td><td style="background-color:red" onclick="dip(this)"></td></tr>
<tr><td style="background-color:silver" onclick="dip(this)"></td><td style="background-color:teal" onclick="dip(this)"></td><td style="background-color:white" onclick="dip(this)"></td><td style="background-color:yellow" onclick="dip(this)"></td></tr>
<tr><td colspan="3"><input style="width:100%" placeholder="╮(╯▽╰)╭"></input></td><td onclick="blend(this.previousElementSibling.firstElementChild.value)">
<svg height="25px" width="25px">
<circle cx="13" cy="3" r="3" style="fill:white"/>
<line x1="9" y1="7" x2="17" y2="7" style="stroke:white;stroke-width:3"/>
<polygon points="11,7 11,20 13,24 15,20 15,7" style="stroke:white" />
</svg>
</td></tr><!--自定义颜色及确认按钮。 Customize color and confirm button.-->
</table></td></tr>
<tr><td>
<svg height="20px" width="20px" style="border:1px solid white" onclick="undo(this)">
<path d="M 4 17 L 11 17 A 6 6, 0, 0 0, 11 5 L 6 5" style="stroke:white;stroke-width:3" />
<polygon points="7,1 2,5 7,9" style="fill:white" />
</svg>
<svg height="20px" width="20px" style="border:1px solid white" onclick="download()">
<line x1="10" y1="0" x2="10" y2="10" style="stroke:white;stroke-width:3" />
<polygon points="5,10 10,15 15,10" style="fill:white" />
<rect x="1" y="16" width="17" height="3" style="stroke:white;stroke-width:2" />
<line x1="15" y1="16" x2="15" y2="19" style="stroke:white;stroke-width:2" />
</svg>
</td></tr>
</table>
</div>
</body>
</html>
